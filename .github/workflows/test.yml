name: Ops4Team Scan (Node.js)

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        if: hashFiles('**/package.json') != ''
        run: |
          npm ci || npm i

      - name: Run ESLint (JSON)
        if: hashFiles('**/.eslintrc*') != ''
        run: npx eslint . --ext .js,.jsx,.ts,.tsx -f json -o ops4-eslint.json || true

      - name: Resolve ESLint config
        shell: bash
        run: |
          PROBE=$(git ls-files '*.ts' '*.tsx' '*.js' '*.jsx' | head -n 1 || echo 'package.json')
          npx eslint --print-config "$PROBE" > ops4-eslint-config.json

      - name: Run npm audit (JSON)
        if: hashFiles('**/package.json') != ''
        run: npm audit --json > ops4-npm-audit.json || true

      - name: Normalize results (Node)
        shell: bash
        run: |
          node <<'NODE'
          const fs = require('fs');
          const crypto = require('crypto');

          const branch =
            process.env.GITHUB_HEAD_REF ||
            process.env.GITHUB_REF_NAME ||
            (process.env.GITHUB_REF || '').replace(/^refs\/heads\//, '');

          const payload = {
            repo: process.env.GITHUB_REPOSITORY,
            sha: process.env.GITHUB_SHA,
            runId: process.env.GITHUB_RUN_ID,
            ref: process.env.GITHUB_REF,
            branch: branch,
            detectedAt: new Date().toISOString(),
            issues: []
          };
          const fp = (s) => crypto.createHash('sha1').update(s).digest('hex');
          const readJSON = (p) => { try { return JSON.parse(fs.readFileSync(p,'utf8')); } catch { return null; } };

          const eslint = readJSON('ops4-eslint.json') || [];
          for (const f of eslint) {
            for (const m of (f.messages || [])) {
              payload.issues.push({
                tool: 'eslint',
                path: f.filePath,
                line: m.line || 1,
                col: m.column || 1,
                endLine: m.endLine || 1,
                endColumn: m.endColumn || 1,
                title: m.ruleId ? `ESLint: ${m.ruleId}` : 'ESLint Issue',
                description: m.message,
                severity: (m.severity === 2) ? 'Error' : 'Warn',
                ruleId: m.ruleId || 'eslint',
                fingerprint: fp(`${f.filePath}:${m.ruleId}:${m.line}:${m.message}`),
              });
            }
          }

          fs.writeFileSync('ops4-payload.json', JSON.stringify(payload, null, 2));
          console.log('Normalized issues:', payload.issues.length);
          NODE

      # ✅ Run Jest tests and generate coverage
      - name: Run Tests with Coverage
        if: hashFiles('**/package.json') != ''
        run: |
          npx jest --coverage --coverageReporters="json-summary" --coverageReporters="lcov" --coverageReporters="text" || true

      # ✅ Aggregate coverage and calculate overall %
      - name: Aggregate Coverage
        id: cov
        shell: bash
        run: |
          node <<'NODE'
          const fs = require('fs');
          const summaryPath = 'coverage/coverage-summary.json';
          if (!fs.existsSync(summaryPath)) {
            console.error('❌ coverage-summary.json not found!');
            process.exit(0);
          }
          const sum = JSON.parse(fs.readFileSync(summaryPath, 'utf8')).total;
          const pct = (cov, tot) => (tot ? ((cov / tot) * 100).toFixed(2) : 0);
          const overall = pct(
            sum.lines.covered + sum.statements.covered + sum.functions.covered + sum.branches.covered,
            sum.lines.total + sum.statements.total + sum.functions.total + sum.branches.total
          );

          const coverage = {
            lines: pct(sum.lines.covered, sum.lines.total),
            statements: pct(sum.statements.covered, sum.statements.total),
            functions: pct(sum.functions.covered, sum.functions.total),
            branches: pct(sum.branches.covered, sum.branches.total),
            overall: overall
          };

          fs.writeFileSync('ops4-coverage.json', JSON.stringify(coverage, null, 2));
          console.log('✅ COVERAGE:', coverage);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `COVERAGE=${coverage.overall}\n`);
          NODE

      # ✅ Fail if coverage < 80%
      - name: Enforce Coverage Threshold (80%)
        run: |
          COVERAGE=$(cat ops4-coverage.json | jq -r '.overall')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "❌ Coverage below 80%! Please improve tests."
            exit 1
          else
            echo "✅ Coverage is above 80%!"
          fi

      # ✅ Attach coverage to payload
      - name: Attach Coverage to Payload
        shell: bash
        run: |
          node <<'NODE'
          const fs = require('fs');
          const payload = JSON.parse(fs.readFileSync('ops4-payload.json', 'utf8'));
          try {
            const cov = JSON.parse(fs.readFileSync('ops4-coverage.json', 'utf8'));
            payload.coverage = cov;
          } catch (err) {
            console.error('⚠️ No coverage file found.');
          }
          fs.writeFileSync('ops4-payload.json', JSON.stringify(payload, null, 2));
          NODE

      # ✅ POST results to Ops4 dashboard
      - name: POST Results to Ops4
        if: always()
        env:
          OPS4_URL: ${{ secrets.OPS4_URL }}
          OPS4_TOKEN: ${{ secrets.OPS4_TOKEN }}
        run: |
          test -f ops4-payload.json || echo '{"issues":[]}' > ops4-payload.json
          curl -sS -X POST "$OPS4_URL/repository-issues" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPS4_TOKEN" \
            --data-binary @ops4-payload.json
